name: CI Pipeline Básico

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    strategy:
      matrix:
        node-version: [18]
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    outputs:
      build-version: ${{ steps.version_step.outputs.version }}
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Obtener versión simulada
        id: version_step
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generar reporte
        run: |
          echo "Reporte de pruebas - versión ${{ steps.version_step.outputs.version }}" > report.txt
          echo "Todas las pruebas pasaron ✅" >> report.txt

      - name: Subir artifact de reporte
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: report.txt

  report:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Descargar artifact de reporte
        uses: actions/download-artifact@v4
        with:
          name: test-report

      - name: Mostrar contenido del reporte
        run: |
          echo "Contenido del reporte:"
          cat report.txt

      - name: Usar versión desde output del job anterior
        run: |
          echo "La versión usada en el job test fue: ${{ needs.test.outputs.build-version }}"

  deploy-staging:
    needs: report
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Mostrar mensaje usando secret a nivel repo
        run: |
          echo "Mensaje secreto del repo: ${{ secrets.DEMO_SECRET_MESSAGE }}"

      - name: Mostrar API KEY del entorno staging
        run: |
          echo "Usando STAGING_API_KEY (no se verá el valor real en logs): ${{ secrets.STAGING_API_KEY }}"
